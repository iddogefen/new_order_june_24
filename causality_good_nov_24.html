<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>My Experiment</title>
    <style>
      /* Optional: Hide cursor if needed */
      .hide_cursor {
        cursor: none;
      }
    </style>
    <!-- Include jsPsych library and plugins -->
    <script src="jspsych/plugins/jspsych.js"></script>
    <script src="jspsych/plugins/plugin-instructions.js"></script>
    <script src="jspsych/plugins/plugin-html-button-response.js"></script>
    <script src="jspsych/plugins/plugin-preload.js"></script>
    <link rel="stylesheet" href="jspsych/css/jspsych.css">
  </head>
  <body></body>

  <script>
    // Define data folder for saving results
    var data_folder = 'data/';

    // Generate a random subject ID
    var subject_id = jsPsych.randomization.randomID(15);

    // Function to save data via POST request
    function saveData(name, data) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'write_data.php'); // PHP file to handle data writing
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({ filedata: data }));
    }

    // Initialize jsPsych
    var jsPsych = initJsPsych({
      on_finish: function () {
        saveData(data_folder + 'all_data_sub_' + subject_id + '.csv', jsPsych.data.get().csv());
      }
    });

    // Initialize timeline
    var timeline = [];

    // -------- INSTRUCTIONS --------
    var instructions = {
      type: jsPsychInstructions,
      pages: [
        '<h2>Welcome!</h2><p>You will see pairs of images.</p><p>Your task is to decide if one caused the other, or if they are unrelated.</p><p>Letâ€™s start with three examples.</p>'
      ],
      show_clickable_nav: true
    };
    timeline.push(instructions);

    // -------- EXAMPLE TRIALS --------
    function createExampleTrial(img1, img2, correctText) {
      const trial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div style="display: flex; justify-content: center;">
            <div style="margin-right: 20px; text-align: center;">
              <p><strong>Event 1</strong></p><img src="${img1}" width="300">
            </div>
            <div style="margin-left: 20px; text-align: center;">
              <p><strong>Event 2</strong></p><img src="${img2}" width="300">
            </div>
          </div>
          <p style="text-align:center;">Did one cause the other?</p>`,
        choices: ['event 1 causes event 2', 'event 2 causes event 1', 'events are unrelated'],
        trial_duration: 60000,
        button_html: '<button class="jspsych-btn" disabled>%choice%</button>',
        on_load: () => {
          setTimeout(() => {
            document.querySelectorAll('.jspsych-btn').forEach(btn => btn.disabled = false);
          }, 5000);
        }
      };
      const feedback = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p><strong>Correct answer:</strong> ${correctText}</p><p>Click next to continue.</p>`,
        choices: ['Next']
      };
      return [trial, feedback];
    }

    timeline.push(...createExampleTrial('images/instructions/1.png', 'images/instructions/2.png', 'event 1 causes event 2'));
    timeline.push(...createExampleTrial('images/instructions/2.png', 'images/instructions/1.png', 'event 2 causes event 1'));
    timeline.push(...createExampleTrial('images/instructions/5.png', 'images/instructions/6.png', 'events are unrelated'));

    // -------- TRANSITION TO EXPERIMENT --------
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: '<h2>Get ready!</h2><p>The actual experiment is about to begin.</p>',
      choices: ['Start']
    });

    // -------- TRIAL GENERATION --------
    const stimulusTypes = [
      'cat_care_semantic', 'creative_activities_semantic', 'exploring_nature_semantic',
      'using_technology_semantic', 'kitchen_operations_semantic', 'maintaining_a_car_semantic',
      'market_semantic', 'self_care_activities_semantic', 'traveling_semantic',
      'restaurant_scheme', 'interview_scheme', 'flight_scheme', 'dinner_party_scheme',
      'hotel_scheme', 'supermarket_scheme', 'coin_causal', 'dog_causal', 'museum_causal',
      'package_causal', 'saving_a_cat_causal', 'the_performance_causal'
    ];

    function generateRandomizedPairs(start, end) {
      let pairs = [];
      for (let i = start; i <= end; i++) {
        for (let j = i + 1; j <= end; j++) {
          pairs.push(Math.random() > 0.5 ? [i, j] : [j, i]);
        }
      }
      return pairs;
    }

    function generateTrialsForStimulus(stimulus_type) {
      let pairs = generateRandomizedPairs(1, 10);
      return pairs.map(pair => ({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div style="display: flex; justify-content: center; align-items: center;">
            <div style="text-align: center; margin-right: 20px;">
              <p><strong>Event 1</strong></p>
              <img src="images/causal/${stimulus_type}/${stimulus_type}_${pair[0]}.png" width="300">
            </div>
            <div style="text-align: center; margin-left: 20px;">
              <p><strong>Event 2</strong></p>
              <img src="images/causal/${stimulus_type}/${stimulus_type}_${pair[1]}.png" width="300">
            </div>
          </div>
          <p style="text-align:center;">Did one cause the other?</p>`,
        choices: ['event 1 causes event 2', 'event 2 causes event 1', 'events are unrelated'],
        trial_duration: 60000,
        button_html: '<button class="jspsych-btn" disabled>%choice%</button>',
        on_load: () => {
          setTimeout(() => {
            document.querySelectorAll('.jspsych-btn').forEach(btn => btn.disabled = false);
          }, 5000);
        },
        on_finish: function(data) {
          data.firstImageNumber = pair[0];
          data.secondImageNumber = pair[1];
          data.response_made = typeof data.response !== 'undefined';
          data.stimulus_type = stimulus_type;
        }
      }));
    }

    let allTrials = [];
    stimulusTypes.forEach(type => {
      allTrials.push(...generateTrialsForStimulus(type));
    });

    let shuffledTrials = jsPsych.randomization.shuffle(allTrials);
    timeline.push(...shuffledTrials);

    // -------- END SCREEN --------
    var end_screen = {
      type: jsPsychInstructions,
      pages: [
        '<h2>Thank you for participating!</h2><p>You have completed the experiment.</p><p>Your code is: <strong>3730E71D97</strong></p>'
      ],
      show_clickable_nav: true
    };
    timeline.push(end_screen);

    // -------- RUN EXPERIMENT --------
    jsPsych.run(timeline);
  </script>
</html>
